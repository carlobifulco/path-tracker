<!DOCTYPE html>  <html> <head>   <title>web_data.rb</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="background.html">                 background.rb               </a>                                           <a class="source" href="configuration.html">                 configuration.rb               </a>                                           <a class="source" href="interface.html">                 interface.rb               </a>                                           <a class="source" href="path-tracker.html">                 path-tracker.rb               </a>                                           <a class="source" href="quick_search.html">                 quick_search.rb               </a>                                           <a class="source" href="report_data.html">                 report_data.rb               </a>                                           <a class="source" href="report_html.html">                 report_html.rb               </a>                                           <a class="source" href="report_new.html">                 report_new.rb               </a>                                           <a class="source" href="report_svg.html">                 report_svg.rb               </a>                                           <a class="source" href="utilities.html">                 utilities.rb               </a>                                           <a class="source" href="web_data.html">                 web_data.rb               </a>                                           <a class="source" href="web_data_spec.html">                 web_data_spec.rb               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               web_data.rb             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="n">my_directory</span><span class="o">=</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">))</span>
<span class="vg">$LOAD_PATH</span> <span class="o">&lt;&lt;</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">my_directory</span><span class="p">,</span><span class="s1">&#39;/lib&#39;</span><span class="p">)</span>
<span class="vg">$LOAD_PATH</span> <span class="o">&lt;&lt;</span> <span class="n">my_directory</span>


<span class="nb">require</span> <span class="s2">&quot;mongo_mapper&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;configuration&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;whenever&quot;</span>
<span class="nb">require</span> <span class="s1">&#39;business_time&#39;</span>
<span class="nb">require</span> <span class="s2">&quot;holidays&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;interface&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>these need to have an existing  connection</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">require</span> <span class="s2">&quot;utilities&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;report_svg&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;report_new&quot;</span>


<span class="k">class</span> <span class="nc">Date</span>
  <span class="k">def</span> <span class="nf">utc</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">to_time</span><span class="o">.</span><span class="n">utc</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">module</span> <span class="nn">DataUtilities</span>

  
  <span class="k">def</span> <span class="nf">export</span> <span class="n">file_path</span>
    <span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">csv</span><span class="o">|</span>
      <span class="n">headers</span><span class="o">=</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">sort</span>
      <span class="nb">puts</span> <span class="n">headers</span>
      <span class="n">csv</span> <span class="o">&lt;&lt;</span> <span class="n">headers</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
        <span class="n">line</span><span class="o">=[]</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">h</span><span class="o">|</span>
          <span class="n">line</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">c</span><span class="o">[</span><span class="n">h</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
        <span class="k">end</span>
        <span class="n">csv</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
      <span class="k">end</span>
      <span class="nb">puts</span> <span class="n">csv</span>
    <span class="k">end</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">pp</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="nb">self</span><span class="o">[</span><span class="n">k</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
    <span class="kp">nil</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Business day conversion</h3>

<p>n is the number of days ahead of today to be converted</p>

<p>Returns a date/time in UTC format of the nth day after today</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_business_utc</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>if future</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="n">business_days</span><span class="o">=</span><span class="p">(((</span><span class="mi">1</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">business_day</span><span class="o">.</span><span class="n">after</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">to_date</span> <span class="o">-</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">to_int</span>
    <span class="k">return</span> <span class="p">(</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="o">+</span><span class="n">business_days</span><span class="p">)</span><span class="o">.</span><span class="n">to_time</span><span class="o">.</span><span class="n">utc</span>
  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>if past</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">business_days</span><span class="o">=</span><span class="p">(</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="o">-</span> <span class="p">((</span><span class="o">-</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">business_day</span><span class="o">.</span><span class="n">before</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">to_date</span><span class="p">)</span><span class="o">.</span><span class="n">to_int</span>
    <span class="k">return</span> <span class="p">(</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="o">-</span><span class="n">business_days</span><span class="p">)</span><span class="o">.</span><span class="n">to_time</span><span class="o">.</span><span class="n">utc</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">get_n_from_utc</span> <span class="n">utc_time</span>
  <span class="o">-</span> <span class="p">(</span><span class="n">utc_time</span><span class="o">.</span><span class="n">to_date</span><span class="o">.</span><span class="n">business_days_until</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>Total Daily Cases container</h3>

<p>This is the days container
It has Pathologists of the day.
And they then have activities...
The status of this is nt actoamtilly updated in regards of teh many it has (Pathologist and Activities)
To get the freshest state of the system I do have to pull out again the same Tdc via the today function
Days are stored as time.utc
Only TDCs for business days are generated.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Tdc</span>
  <span class="kp">include</span> <span class="no">MongoMapper</span><span class="o">::</span><span class="no">Document</span>
  <span class="kp">include</span> <span class="no">DataUtilities</span>
  <span class="n">safe</span>
  <span class="n">key</span> <span class="ss">:pathologists</span><span class="p">,</span> <span class="nb">Array</span>
  <span class="n">many</span> <span class="ss">:pathologist</span><span class="p">,</span> <span class="ss">:in</span> <span class="o">=&gt;</span> <span class="ss">:pathologists</span> <span class="c1">#objects are in pathologist; ids in pathologists</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>old entries</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">key</span> <span class="ss">:blocks_west</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:blocks_east</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:blocks_hr</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>new entries</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">key</span> <span class="ss">:tot_points</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:blocks_tot</span><span class="p">,</span><span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:total_GI</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:total_SO</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:total_ESD</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:left_over_previous_day_slides</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:total_cytology</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:expected_generalist_distribution_slides</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:tot_points_pathologist</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>date stores the Tdc instance day in a utc representation of the date
this is the dataset used to pull out Tdc instances if they are already existing</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">key</span> <span class="ss">:date</span><span class="p">,</span> <span class="no">Time</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>n is the number of <strong>working</strong> days ahead of today</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">key</span> <span class="ss">:n</span><span class="p">,</span> <span class="nb">Integer</span>


  <span class="k">def</span> <span class="nf">show_date</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nb">puts</span> <span class="nb">self</span><span class="o">.</span><span class="n">date</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h5>Returns only one Tdc and always the same for a certain day</h5>

<p>n is the number of days from today</p>

<p>Returns an instance of Tdc</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">today</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">business_utc</span><span class="o">=</span><span class="n">get_business_utc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">d</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">business_utc</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>existing instance n working days ahead of today</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">count</span><span class="o">&gt;</span><span class="mi">0</span>
      <span class="n">t</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">to_a</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>update the t.n (t.n was setup on the day of creation but now it could have to be changed)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="n">t</span><span class="o">.</span><span class="n">n</span><span class="o">=</span><span class="p">(</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="o">.</span><span class="n">business_days_until</span> <span class="n">t</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_date</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_date</span><span class="p">)</span>
      <span class="n">t</span><span class="o">.</span><span class="n">n</span><span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_date</span><span class="o">.</span><span class="n">business_days_until</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="o">&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_date</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">pathologist</span><span class="o">.</span><span class="n">count</span><span class="o">==</span><span class="mi">0</span>
        <span class="n">t</span><span class="o">.</span><span class="n">populate</span>
      <span class="k">end</span>
      <span class="n">t</span><span class="o">.</span><span class="n">save</span>
      <span class="k">return</span> <span class="n">t</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>new instance</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="n">t</span><span class="o">=</span><span class="no">Tdc</span><span class="o">.</span><span class="n">new</span>
      <span class="n">t</span><span class="o">.</span><span class="n">n</span><span class="o">=</span><span class="n">n</span>
      <span class="n">t</span><span class="o">.</span><span class="n">date</span><span class="o">=</span><span class="n">business_utc</span>
      <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">pathologist</span><span class="o">.</span><span class="n">count</span><span class="o">==</span><span class="mi">0</span> <span class="k">then</span> <span class="n">t</span><span class="o">.</span><span class="n">populate</span><span class="p">;</span> <span class="n">t</span><span class="o">.</span><span class="n">save</span>  <span class="k">end</span>
      <span class="k">return</span> <span class="n">t</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h6>Gives the day it's Pathologist</h6>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">populate</span>
    <span class="nb">puts</span> <span class="s2">&quot;populating???&quot;</span>
    <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;initials&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">ini</span><span class="o">|</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>create if not existing</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="ow">not</span> <span class="no">Pathologist</span><span class="o">.</span><span class="n">where</span><span class="p">({</span><span class="ss">:ini</span><span class="o">=&gt;</span><span class="n">ini</span><span class="p">,</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="nb">self</span><span class="o">.</span><span class="n">date</span><span class="p">})</span><span class="o">.</span><span class="n">any?</span>
        <span class="nb">p</span><span class="o">=</span><span class="no">Pathologist</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="ss">:ini</span><span class="o">=&gt;</span><span class="n">ini</span><span class="p">,</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="nb">self</span><span class="o">.</span><span class="n">date</span><span class="p">})</span>
        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="nb">p</span><span class="o">.</span><span class="n">ini</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="nb">p</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">p</span><span class="o">.</span><span class="n">save</span>
           <span class="nb">puts</span> <span class="s2">&quot;saved </span><span class="si">#{</span><span class="nb">p</span><span class="o">.</span><span class="n">ini</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span>
          <span class="nb">puts</span> <span class="s2">&quot;Error(s): &quot;</span><span class="p">,</span> <span class="nb">p</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="k">end</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">pathologist</span><span class="o">&lt;&lt;</span><span class="nb">p</span>
        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">ini</span><span class="si">}</span><span class="s2"> created with date </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>append if existing and not loaded</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">pathologist</span><span class="o">&lt;&lt;</span><span class="no">Pathologist</span><span class="o">.</span><span class="n">where</span><span class="p">({</span><span class="ss">:ini</span><span class="o">=&gt;</span><span class="n">ini</span><span class="p">,</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="nb">self</span><span class="o">.</span><span class="n">date</span><span class="p">})</span><span class="o">.</span><span class="n">first</span>
        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">ini</span><span class="si">}</span><span class="s2"> already existing with date </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">save</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>only todays match</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">get_path</span> <span class="n">ini</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">pathologist</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">ini</span><span class="o">==</span><span class="n">ini</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_working</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">pathologist</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">working</span><span class="o">==</span><span class="kp">true</span><span class="p">}</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Shows who is doing what</p>

<p>for all dates</p>

<p>for debugging purposes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">debug</span>
    <span class="no">Tdc</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">sort_by</span><span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="p">}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="s2">&quot;Date: </span><span class="si">#{</span><span class="n">t</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">, Working days: </span><span class="si">#{</span><span class="n">t</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">t</span><span class="o">.</span><span class="n">get_working</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="nb">p</span><span class="o">.</span><span class="n">ini</span><span class="si">}</span><span class="s2">: specialty-only=</span><span class="si">#{</span><span class="nb">p</span><span class="o">.</span><span class="n">specialty_only</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">p</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
          <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">#{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">a</span><span class="o">.</span><span class="n">tot_points</span><span class="si">}</span><span class="s2">; &quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="kp">nil</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>magic souce formula....
total of all expected slide points
blocks enetered are generalist blocks only</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">get_predicted_points_slide_tot</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>conversion blocks slides</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="n">total_slide_points</span><span class="o">=</span> <span class="no">SLIDES_CONVERSION_FACTOR</span> <span class="o">*</span> <span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">blocks_west</span><span class="o">+</span><span class="nb">self</span><span class="o">.</span><span class="n">blocks_east</span><span class="o">+</span><span class="nb">self</span><span class="o">.</span><span class="n">blocks_hr</span><span class="p">)</span>
     <span class="n">total_slide_points</span><span class="o">.</span><span class="n">to_int</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>tot of all expected points
again generalist blocks and activities only</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">get_predicted_points_all</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">tot_points</span><span class="o">=</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">get_predicted_points_slide_tot</span> <span class="o">+</span> <span class="no">Activity</span><span class="o">.</span><span class="n">get_general_non_slide_points</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>index Tdc</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="no">Tdc</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="ss">:date</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">tot_points</span> <span class="n">path_list</span>
  <span class="n">activities</span><span class="o">=[]</span>
  <span class="n">path_list</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="n">activities</span><span class="o">+=</span><span class="nb">p</span><span class="o">.</span><span class="n">activities</span><span class="p">}</span>
  <span class="n">activities</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span><span class="n">a</span><span class="o">.</span><span class="n">tot_points</span><span class="p">}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>:Numebr of days is here absolute and not business days (n)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Pathologist</span>
  <span class="kp">include</span> <span class="no">MongoMapper</span><span class="o">::</span><span class="no">Document</span>
  <span class="kp">include</span> <span class="no">DataUtilities</span>
  <span class="n">safe</span>
  <span class="n">belongs_to</span> <span class="ss">:tdc</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>initials</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">key</span> <span class="ss">:ini</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">:required</span> <span class="o">=&gt;</span><span class="kp">true</span>
  <span class="n">key</span> <span class="ss">:site</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">key</span> <span class="ss">:date</span><span class="p">,</span> <span class="no">Time</span>
  <span class="n">key</span> <span class="ss">:working</span><span class="p">,</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="kp">true</span>
  <span class="n">key</span> <span class="ss">:specialty_only</span><span class="p">,</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="kp">false</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>array where instances of Activity get packed and assigned via &lt;&lt;</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">many</span> <span class="ss">:activities</span>
  <span class="n">key</span> <span class="ss">:location</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">before_save</span> <span class="ss">:update_site</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>important  --remove activity if path is at home...</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">after_update</span> <span class="ss">:delete_activities_if_not_working</span>

  <span class="k">def</span> <span class="nf">update_site</span>
    <span class="k">if</span>  <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;b_psv&quot;</span><span class="o">].</span><span class="n">include?</span> <span class="nb">self</span><span class="o">.</span><span class="n">ini</span>
     <span class="nb">self</span><span class="o">.</span><span class="n">location</span><span class="o">=</span><span class="s2">&quot;b_psv&quot;</span>
    <span class="k">elsif</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;c_ppmc&quot;</span><span class="o">].</span><span class="n">include?</span> <span class="nb">self</span><span class="o">.</span><span class="n">ini</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">location</span><span class="o">=</span><span class="s2">&quot;c_ppmc&quot;</span>
    <span class="k">elsif</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;d_core&quot;</span><span class="o">].</span><span class="n">include?</span> <span class="nb">self</span><span class="o">.</span><span class="n">ini</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">location</span><span class="o">=</span><span class="s2">&quot;d_core&quot;</span>
    <span class="k">elsif</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;a_hr&quot;</span><span class="o">].</span><span class="n">include?</span> <span class="nb">self</span><span class="o">.</span><span class="n">ini</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">location</span><span class="o">=</span><span class="s2">&quot;a_hr&quot;</span>
    <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>these before save methods need to return true if all goes well</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kp">true</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">delete_activities_if_not_working</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>puts "#{self} getting called"</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">self</span><span class="o">.</span><span class="n">working</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>puts "deleting"</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">(</span><span class="no">Activity</span><span class="o">.</span><span class="n">find_all_by_pathologist_id</span>  <span class="nb">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>puts "deleting #{a}"</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">a</span><span class="o">.</span><span class="n">delete</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>this needed to be done at a pathologist level
Otherives had save save atcivity loops...
This is called from interface.rb if cardinal activity matches list
of psecialty only cases</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">update_specialty_status</span> <span class="n">activity_name</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>puts "updating specialty status"</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nb">self</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
        <span class="n">a</span><span class="o">.</span><span class="n">specialty_only</span><span class="o">=</span><span class="kp">true</span>
        <span class="n">a</span><span class="o">.</span><span class="n">specialty</span><span class="o">=</span><span class="n">activity_name</span>
        <span class="n">a</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_all_path</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">d</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="p">(</span><span class="n">get_business_utc</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="n">d</span><span class="o">.</span><span class="n">to_a</span> <span class="k">if</span> <span class="n">d</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_path_working</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">d</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:working</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="ss">:date</span><span class="o">=&gt;</span><span class="p">(</span><span class="n">get_business_utc</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="n">d</span><span class="o">.</span><span class="n">to_a</span> <span class="k">if</span> <span class="n">d</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_number_generalist</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">get_generalist</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_generalist</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">get_path_working</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">specialty_only</span><span class="o">==</span><span class="kp">false</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_specialist</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">get_path_working</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">specialty_only</span><span class="o">==</span><span class="kp">true</span><span class="p">}</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Main data structure for rendering</p>

<p>Returns dict with initials, points range, location and pathologist initial</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">path_all_points</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pathologist</span><span class="o">=</span><span class="nb">self</span><span class="o">.</span><span class="n">get_path_working</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>n=working_n n</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">t</span><span class="o">=</span><span class="no">Tdc</span><span class="o">.</span><span class="n">today</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">pc</span><span class="o">=</span><span class="no">PointsCalculator</span><span class="o">.</span><span class="n">new</span>
    <span class="n">points_per_path</span><span class="o">=</span><span class="n">pc</span><span class="o">.</span><span class="n">predicted_points_per_non_specialist</span>
    <span class="n">path_all_points</span><span class="o">=[]</span>
    <span class="n">pathologist</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
      <span class="n">path_all_points</span><span class="o">&lt;&lt;</span><span class="p">{</span><span class="n">ini</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ini</span><span class="p">,</span> <span class="n">tot</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">total_points</span><span class="p">,</span> <span class="n">slides</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">slide_points</span><span class="p">,</span> <span class="n">range</span><span class="p">:</span> <span class="n">points_per_path</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">location</span><span class="p">}</span>
    <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Sort by location</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">path_all_points</span><span class="o">.</span><span class="n">sort_by</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
      <span class="o">[</span><span class="n">a</span><span class="o">[</span><span class="ss">:location</span><span class="o">]</span><span class="p">,</span><span class="n">a</span><span class="o">[</span><span class="ss">:ini</span><span class="o">]]</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">path_all_points_generalist</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">path_all_points</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">self</span><span class="o">.</span><span class="n">get_generalist</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">path_all_points_specialist</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">path_all_points</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">self</span><span class="o">.</span><span class="n">get_specialist</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">all_paths</span>
    <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;initials&quot;</span><span class="o">]</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>main data source for visualization of bars in entry</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">all_activities_points</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">r</span><span class="o">=</span><span class="p">{}</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">get_path_working</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">r</span><span class="o">[</span><span class="n">x</span><span class="o">.</span><span class="n">ini</span><span class="o">]=</span><span class="n">x</span><span class="o">.</span><span class="n">activities_points</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">r</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">all_activities_points_generalist</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">r</span><span class="o">=</span><span class="p">{}</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">get_generalist</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">r</span><span class="o">[</span><span class="n">x</span><span class="o">.</span><span class="n">ini</span><span class="o">]=</span><span class="n">x</span><span class="o">.</span><span class="n">activities_points</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">r</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>main data source for visualization of bars in live</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">activities_points</span>
    <span class="n">activities_points</span><span class="o">=</span><span class="p">{}</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">activities_points</span><span class="o">[</span><span class="n">x</span><span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]]=</span><span class="p">{</span><span class="n">tot_points</span><span class="p">:</span> <span class="n">x</span><span class="o">[</span><span class="s1">&#39;tot_points&#39;</span><span class="o">]</span><span class="p">,</span>
                                                            <span class="n">n</span><span class="p">:</span> <span class="n">x</span><span class="o">[</span><span class="ss">:n</span><span class="o">]</span><span class="p">}}</span>
    <span class="n">activities_points</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>checks all activities and sums their points</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">total_points</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">tot_points</span><span class="p">}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>selected slide related activity and return the sum of their points</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">slide_points</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;slide_activities&quot;</span><span class="o">].</span><span class="n">include?</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">}</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">tot_points</span><span class="p">}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>index Pathologist</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="no">Pathologist</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="o">[[</span><span class="ss">:date</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:working</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="o">]]</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Activity</span> 
  <span class="kp">include</span> <span class="no">MongoMapper</span><span class="o">::</span><span class="no">Document</span>
  <span class="kp">include</span> <span class="no">DataUtilities</span>
  <span class="n">safe</span>
  <span class="n">key</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">key</span> <span class="ss">:n</span><span class="p">,</span><span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:points</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="mi">0</span>
  <span class="n">key</span> <span class="ss">:date</span><span class="p">,</span> <span class="no">Time</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="o">.</span><span class="n">to_time</span><span class="o">.</span><span class="n">utc</span>
  <span class="n">key</span> <span class="ss">:tot_points</span><span class="p">,</span> <span class="nb">Integer</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>pathologist initials</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">key</span> <span class="ss">:ini</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">key</span> <span class="ss">:specialty_only</span><span class="p">,</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">:default</span><span class="o">=&gt;</span><span class="kp">false</span>
  <span class="n">key</span> <span class="ss">:specialty</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:pathologist</span>
  <span class="n">before_save</span> <span class="ss">:update_tot_points</span><span class="p">,</span> <span class="ss">:update_time</span>
  <span class="n">before_update</span> <span class="ss">:update_tot_points</span>
  <span class="n">key</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="nb">Array</span>
  <span class="n">before_destroy</span> <span class="ss">:uncheck_subspecialty</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>callback.  Time stamp array.  Only if N is modified or new</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">update_time</span>
    <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">==</span> <span class="o">[]</span>
       <span class="nb">self</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">]</span>
    <span class="k">else</span>
       <span class="nb">self</span><span class="o">.</span><span class="n">updated_at</span>  <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">]</span> <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">updated_at</span><span class="o">[-</span><span class="mi">1</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span> <span class="o">!=</span> <span class="nb">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>callback ; called upon destruction
resets specialty staus of other activities owner by the pathologist</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">uncheck_subspecialty</span>
      <span class="k">if</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;distribution-specialty&quot;</span><span class="o">].</span><span class="n">keys</span><span class="o">.</span><span class="n">include?</span> <span class="nb">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">(</span><span class="no">Activity</span><span class="o">.</span><span class="n">where</span> <span class="ss">:pathologist_id</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">pathologist_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
          <span class="n">a</span><span class="o">.</span><span class="n">specialty_only</span><span class="o">=</span><span class="kp">false</span>
          <span class="n">a</span><span class="o">.</span><span class="n">specialty</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
          <span class="n">a</span><span class="o">.</span><span class="n">save</span>
        <span class="k">end</span>
      <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>this should log any activity destructiom</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nb">puts</span> <span class="s2">&quot;Destruction happening, trying to log&quot;</span>
      <span class="n">l</span><span class="o">=</span><span class="no">Log</span><span class="o">.</span><span class="n">new</span>
      <span class="n">l</span><span class="o">.</span><span class="n">path_ini</span><span class="o">=</span><span class="nb">self</span><span class="o">.</span><span class="n">ini</span>
      <span class="n">l</span><span class="o">.</span><span class="n">time</span><span class="o">=</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span><span class="p">()</span>
      <span class="n">l</span><span class="o">.</span><span class="n">date</span><span class="o">=</span><span class="n">get_business_utc</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">l</span><span class="o">.</span><span class="n">request</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;database destruction&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">}</span><span class="o">.</span><span class="n">to_json</span>
      <span class="n">l</span><span class="o">.</span><span class="n">ip</span><span class="o">=</span><span class="nb">self</span><span class="o">.</span><span class="n">name</span>
      <span class="nb">puts</span> <span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">path_ini</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">request</span>
      <span class="n">l</span><span class="o">.</span><span class="n">save</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">today</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">d</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">get_business_utc</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="n">d</span><span class="o">.</span><span class="n">to_a</span> <span class="k">if</span> <span class="n">d</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_ini_name</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">path_ini</span><span class="p">,</span><span class="n">activity_name</span>
    <span class="n">d</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">get_business_utc</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="ss">:ini</span><span class="o">=&gt;</span><span class="n">path_ini</span><span class="p">,</span> <span class="ss">:name</span><span class="o">=&gt;</span><span class="n">activity_name</span><span class="p">)</span>
    <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">to_a</span> <span class="k">if</span> <span class="n">d</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="k">then</span> <span class="k">return</span>  <span class="n">d</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="k">else</span> <span class="k">return</span> <span class="kp">false</span> <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">all_activities</span>
    <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;regular_activities&quot;</span><span class="o">].</span><span class="n">merge</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;cardinal_activities&quot;</span><span class="o">]</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>all activities points unless slide related</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_non_slide_points</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">slide_activities</span><span class="o">=</span><span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;slide_activities&quot;</span><span class="o">]</span><span class="p">;</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">today</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
       <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="o">.</span><span class="n">tot_points</span> <span class="k">unless</span> <span class="n">slide_activities</span><span class="o">.</span><span class="n">member?</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span>
    <span class="k">end</span>
    <span class="n">x</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_specialist_slides_distributed</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">date</span><span class="o">=</span><span class="n">get_business_utc</span> <span class="n">n</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>find pathologists ids on derm and GI</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">p_inis</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">date</span><span class="p">,</span> <span class="ss">:name</span><span class="o">=&gt;</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;no-points&quot;</span><span class="o">].</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">ini</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>find slide activities with non specialist</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">m</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">date</span><span class="p">,</span> <span class="ss">:name</span><span class="o">=&gt;</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;slide_activities&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:ini</span><span class="o">=&gt;</span><span class="n">p_inis</span><span class="p">)</span><span class="o">.</span><span class="n">all</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">m</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">tot_points</span><span class="p">}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_specialist_non_slide_points</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">date</span><span class="o">=</span><span class="n">get_business_utc</span> <span class="n">n</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>find pathologists ids on derm and GI for the day</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">p_inis</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">date</span><span class="p">,</span> <span class="ss">:name</span><span class="o">=&gt;</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;no-points&quot;</span><span class="o">].</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">ini</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>find slide activities with non specialist</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">m</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">date</span><span class="p">,</span> <span class="ss">:name</span><span class="o">=&gt;</span> <span class="p">{:</span><span class="vg">$nin</span><span class="o">=&gt;</span><span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;slide_activities&quot;</span><span class="o">]</span><span class="p">},</span> <span class="ss">:ini</span><span class="o">=&gt;</span><span class="n">p_inis</span><span class="p">)</span><span class="o">.</span><span class="n">all</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">m</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">tot_points</span><span class="p">}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>searches subspecialists for the activity date
and the checks is the</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">has_path_subspecialty?</span> <span class="n">subspecialty_name</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">pathologist</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">}</span><span class="o">.</span><span class="n">include?</span> <span class="n">subspecialty_name</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>all activities points only for generalists unless slide related</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_general_non_slide_points</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">date</span><span class="o">=</span><span class="n">get_business_utc</span> <span class="n">n</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>find pathologists ids on derm and GI</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">p_inis</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">date</span><span class="p">,</span> <span class="ss">:name</span><span class="o">=&gt;</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;no-points&quot;</span><span class="o">].</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">ini</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>m=where(:date=>date, :name=> {:$nin=>DATA["slide_activities"]},  :ini=> {:$nin=>p}).all</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">m</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">date</span><span class="p">,</span> <span class="ss">:name</span><span class="o">=&gt;</span> <span class="p">{:</span><span class="vg">$nin</span><span class="o">=&gt;</span><span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;slide_activities&quot;</span><span class="o">]</span><span class="p">},</span> <span class="ss">:ini</span><span class="o">=&gt;</span> <span class="p">{:</span><span class="vg">$nin</span><span class="o">=&gt;</span><span class="n">p_inis</span><span class="p">})</span><span class="o">.</span><span class="n">all</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">m</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">tot_points</span><span class="p">}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>XXX
map to YAML data file
eliminate no points entries (i.e Dermath and GI  and hemepath only from distribution)
since points per slides ==1 this gives also teh total number of slides points</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_general_slides_distributed</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>n time</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">date</span><span class="o">=</span><span class="n">get_business_utc</span> <span class="n">n</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>find pathologists ids on derm and GI</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nb">p</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">date</span><span class="p">,</span> <span class="ss">:name</span><span class="o">=&gt;</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;no-points&quot;</span><span class="o">].</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">ini</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>find all cases with slides</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">m</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">date</span><span class="p">,</span> <span class="ss">:name</span><span class="o">=&gt;</span> <span class="no">DATA</span><span class="o">[</span><span class="s2">&quot;slide_activities&quot;</span><span class="o">]</span><span class="p">,</span><span class="ss">:specialty_only</span><span class="o">=&gt;</span> <span class="kp">false</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">((</span><span class="n">m</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">n</span><span class="p">}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>.map{|x| x.n}.reduce(:+)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">end</span>

 
  <span class="k">def</span> <span class="nf">update_tot_points</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">tot_points</span><span class="o">=</span><span class="nb">self</span><span class="o">.</span><span class="n">points</span><span class="o">*</span><span class="nb">self</span><span class="o">.</span><span class="n">n</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>index activities</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="no">Activity</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="o">[[</span><span class="ss">:date</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:pathologist_id</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:name</span><span class="p">,</span><span class="mi">1</span><span class="o">]]</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">Log</span>
  <span class="kp">include</span> <span class="no">MongoMapper</span><span class="o">::</span><span class="no">Document</span>
  <span class="kp">include</span> <span class="no">DataUtilities</span>
  <span class="n">safe</span>
  <span class="n">key</span> <span class="ss">:path_ini</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">key</span> <span class="ss">:request</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">key</span> <span class="ss">:date</span><span class="p">,</span> <span class="no">Time</span>
  <span class="n">key</span> <span class="ss">:time</span><span class="p">,</span> <span class="no">Time</span>
  <span class="n">key</span> <span class="ss">:ip</span><span class="p">,</span> <span class="nb">String</span>


  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_ini</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">path_ini</span>
    <span class="n">d</span><span class="o">=</span><span class="n">where</span><span class="p">(</span><span class="ss">:date</span><span class="o">=&gt;</span><span class="n">get_business_utc</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="ss">:path_ini</span><span class="o">=&gt;</span><span class="n">path_ini</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="ss">:time</span><span class="p">)</span>
    <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">to_a</span> <span class="k">if</span> <span class="n">d</span>
    <span class="n">text</span><span class="o">=[]&lt;&lt;</span><span class="s2">&quot;&lt;h1&gt;Log&lt;/h1&gt;&lt;ul&gt;&quot;</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span><span class="mi">0</span> 
      <span class="n">d</span><span class="o">.</span><span class="n">each</span>  <span class="k">do</span>  <span class="o">|</span><span class="n">log</span><span class="o">|</span> 
        <span class="n">text</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;&lt;li&gt;</span><span class="si">#{</span><span class="n">log</span><span class="o">.</span><span class="n">ip</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">log</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_time</span><span class="si">}</span><span class="s2"> &lt;br&gt; </span><span class="si">#{</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">request</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/li&gt;&quot;</span> 
      <span class="k">end</span>
      <span class="n">text</span> <span class="o">&lt;&lt;</span><span class="s2">&quot;&lt;/ul&gt;&quot;</span>
      <span class="n">text</span><span class="o">.</span><span class="n">join</span>
    <span class="k">else</span> 
      <span class="k">return</span> <span class="s2">&quot;&lt;h6&gt;No Matches;  Please Use initials in CAPS&lt;/h6&gt;&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Log</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="o">[[</span><span class="ss">:date</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:path_ini_id</span><span class="p">,</span> <span class="mi">1</span><span class="o">]]</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 